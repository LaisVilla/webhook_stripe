<!-- app/templates/financial.html -->
{% extends "base.html" %}

{% block title %}Financeiro - NexusAI{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-white">Gestão Financeira</h1>
    <button onclick="showFinancialModal('create')" 
            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-cyan-500 text-white rounded-lg 
                   hover:opacity-90 transition-all duration-200 flex items-center gap-2">
        <i class="lucide lucide-plus h-5 w-5"></i>
        <span>Novo Registro</span>
    </button>
</div>

<!-- Dashboard Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Mensal -->
    <div class="bg-[#1E293B] rounded-xl shadow-xl border border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Total Mensal</h3>
            <i class="lucide lucide-currency-brl text-green-500 h-6 w-6"></i>
        </div>
        <p class="text-3xl font-bold text-green-500 mt-2" id="monthlyTotal">R$ 0,00</p>
    </div>

    <!-- Pendentes -->
    <div class="bg-[#1E293B] rounded-xl shadow-xl border border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Pendentes</h3>
            <i class="lucide lucide-clock text-yellow-500 h-6 w-6"></i>
        </div>
        <p class="text-3xl font-bold text-yellow-500 mt-2" id="pendingTotal">R$ 0,00</p>
    </div>

    <!-- Total de Atendimentos -->
    <div class="bg-[#1E293B] rounded-xl shadow-xl border border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Atendimentos</h3>
            <i class="lucide lucide-users text-blue-500 h-6 w-6"></i>
        </div>
        <p class="text-3xl font-bold text-blue-500 mt-2" id="appointmentCount">0</p>
    </div>
</div>

<!-- Tabela de Registros -->
<div class="bg-[#1E293B] rounded-xl shadow-xl border border-gray-700 p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-white">Registros Financeiros</h2>
        <div class="flex gap-4">
            <input type="month" id="monthFilter" 
                   class="bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
            <select id="statusFilter" 
                    class="bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                <option value="all">Todos os Status</option>
                <option value="paid">Pago</option>
                <option value="pending">Pendente</option>
                <option value="overdue">Atrasado</option>
            </select>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left text-white">
            <thead class="bg-gray-700/50">
                <tr>
                    <th class="p-4">Paciente</th>
                    <th class="p-4">Data</th>
                    <th class="p-4">Valor</th>
                    <th class="p-4">Método</th>
                    <th class="p-4">Status</th>
                    <th class="p-4">Ações</th>
                </tr>
            </thead>
            <tbody id="financialRecordsTable">
                <!-- Registros serão inseridos aqui -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Registro Financeiro -->
<div id="financialModal" class="hidden fixed inset-0 bg-gray-900/75 backdrop-blur-sm z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-[#1E293B] w-full max-w-md rounded-xl shadow-xl border border-gray-700">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-semibold text-white"></h3>
                    <button onclick="closeFinancialModal()" 
                            class="text-gray-400 hover:text-white">
                        <i class="lucide lucide-x h-5 w-5"></i>
                    </button>
                </div>

                <form id="financialForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Nome do Paciente*
                        </label>
                        <input type="text" id="patientName" required 
                               class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Valor*
                        </label>
                        <input type="number" id="appointmentValue" required step="0.01" min="0"
                               class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Data do Atendimento*
                        </label>
                        <input type="datetime-local" id="appointmentDate" required
                               class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Método de Pagamento*
                        </label>
                        <select id="paymentMethod" required
                                class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                            <option value="cash">Dinheiro</option>
                            <option value="credit">Cartão de Crédito</option>
                            <option value="debit">Cartão de Débito</option>
                            <option value="pix">PIX</option>
                            <option value="insurance">Convênio</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Status*
                        </label>
                        <select id="paymentStatus" required
                                class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white">
                            <option value="paid">Pago</option>
                            <option value="pending">Pendente</option>
                            <option value="overdue">Atrasado</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">
                            Observações
                        </label>
                        <textarea id="notes" rows="3"
                                 class="w-full bg-[#0F172A] border border-gray-700 rounded-lg px-4 py-2 text-white"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeFinancialModal()"
                                class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-gradient-to-r from-purple-500 to-cyan-500 text-white rounded-lg 
                                       hover:opacity-90">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Estado global
const STATE = {
    currentRecord: null,
    records: [],
};

// Funções auxiliares
const formatCurrency = (value) => {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
};

const formatDate = (dateString) => {
    return new Date(dateString).toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

// Carregar registros
async function loadFinancialRecords() {
    try {
        const response = await fetch('/api/financial/records');
        if (!response.ok) throw new Error('Erro ao carregar registros');
        
        const records = await response.json();
        STATE.records = records;
        
        updateDashboard();
        updateTable();
    } catch (error) {
        console.error('Error:', error);
        showNotification('Erro ao carregar registros', 'error');
    }
}

// Atualizar dashboard
function updateDashboard() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyRecords = STATE.records.filter(record => {
        const recordDate = new Date(record.appointment_date);
        return recordDate.getMonth() === currentMonth && 
               recordDate.getFullYear() === currentYear;
    });
    
    const monthlyTotal = monthlyRecords.reduce((sum, record) => 
        sum + record.appointment_value, 0);
    
    const pendingTotal = STATE.records
        .filter(record => record.status === 'pending')
        .reduce((sum, record) => sum + record.appointment_value, 0);
    
    document.getElementById('monthlyTotal').textContent = formatCurrency(monthlyTotal);
    document.getElementById('pendingTotal').textContent = formatCurrency(pendingTotal);
    document.getElementById('appointmentCount').textContent = monthlyRecords.length;
}

// Atualizar tabela
function updateTable() {
    const tbody = document.getElementById('financialRecordsTable');
    tbody.innerHTML = '';
    
    STATE.records.forEach(record => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-700 hover:bg-gray-700/30';
        
        tr.innerHTML = `
            <td class="p-4">${record.patient_name}</td>
            <td class="p-4">${formatDate(record.appointment_date)}</td>
            <td class="p-4">${formatCurrency(record.appointment_value)}</td>
            <td class="p-4">${getPaymentMethodLabel(record.payment_method)}</td>
            <td class="p-4">
                <span class="px-3 py-1 rounded-full text-sm ${getStatusStyle(record.status)}">
                    ${getStatusLabel(record.status)}
                </span>
            </td>
            <td class="p-4">
                <button onclick="editRecord('${record.record_id}')"
                        class="text-blue-500 hover:text-blue-400">
                    <i class="lucide lucide-pencil h-4 w-4"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

// Funções de UI
function getPaymentMethodLabel(method) {
    const labels = {
        cash: 'Dinheiro',
        credit: 'Crédito',
        debit: 'Débito',
        pix: 'PIX',
        insurance: 'Convênio'
    };
    return labels[method] || method;
}

function getStatusLabel(status) {
    const labels = {
        paid: 'Pago',
        pending: 'Pendente',
        overdue: 'Atrasado'
    };
    return labels[status] || status;
}

function getStatusStyle(status) {
    const styles = {
        paid: 'bg-green-500/20 text-green-500',
        pending: 'bg-yellow-500/20 text-yellow-500',
        overdue: 'bg-red-500/20 text-red-500'
    };
    return styles[status] || 'bg-gray-500/20 text-gray-500';
}

// Inicialização quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página financeira carregada');  // Debug
    loadFinancialRecords();
    
    // Configurar listeners de filtros
    document.getElementById('monthFilter').addEventListener('change', updateTable);
    document.getElementById('statusFilter').addEventListener('change', updateTable);
    
    // Configurar formulário
    document.getElementById('financialForm').addEventListener('submit', handleFormSubmit);
    
    // Criar ícones
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// Notificação
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white z-50`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Manipulação do formulário
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = {
        patient_name: document.getElementById('patientName').value,
        appointment_value: parseFloat(document.getElementById('appointmentValue').value),
        appointment_date: document.getElementById('appointmentDate').value,
        payment_method: document.getElementById('paymentMethod').value,
        status: document.getElementById('paymentStatus').value,
        notes: document.getElementById('notes').value
    };

    try {
        const url = STATE.currentRecord 
            ? `/api/financial/records/${STATE.currentRecord.record_id}`
            : '/api/financial/records';
            
        const method = STATE.currentRecord ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();
        if (data.status === 'success') {
            await loadFinancialRecords();
            closeFinancialModal();
            showNotification(
                STATE.currentRecord 
                    ? 'Registro atualizado com sucesso!'
                    : 'Registro criado com sucesso!'
            );
        } else {
            throw new Error(data.message || 'Erro ao salvar registro');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Erro ao salvar registro', 'error');
    }
}

// Funções do modal
function showFinancialModal(mode, recordId = null) {
    const modal = document.getElementById('financialModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('financialForm');
    
    modal.classList.remove('hidden');
    
    if (mode === 'create') {
        modalTitle.textContent = 'Novo Registro';
        form.reset();
        STATE.currentRecord = null;
    } else if (mode === 'edit' && recordId) {
        modalTitle.textContent = 'Editar Registro';
        const record = STATE.records.find(r => r.record_id === recordId);
        if (record) {
            STATE.currentRecord = record;
            document.getElementById('patientName').value = record.patient_name;
            document.getElementById('appointmentValue').value = record.appointment_value;
            document.getElementById('appointmentDate').value = formatDateForInput(record.appointment_date);
            document.getElementById('paymentMethod').value = record.payment_method;
            document.getElementById('paymentStatus').value = record.status;
            document.getElementById('notes').value = record.notes || '';
        }
    }
}

function closeFinancialModal() {
    document.getElementById('financialModal').classList.add('hidden');
    document.getElementById('financialForm').reset();
    STATE.currentRecord = null;
}

// Função para editar registro
function editRecord(recordId) {
    showFinancialModal('edit', recordId);
}

// Função auxiliar para formatar data para input
function formatDateForInput(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
</script>
{% endblock %}